#!/usr/bin/env bash
# Development helper script for Docker/OrbStack workflow

set -e

COMPOSE_CMD="docker compose"

# Colors for output
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

function print_usage() {
  echo "Usage: bin/dev-docker [command]"
  echo ""
  echo "Commands:"
  echo "  up              Start all services"
  echo "  down            Stop all services"
  echo "  restart         Restart all services"
  echo "  build           Rebuild containers"
  echo "  logs            Show logs (use -f for follow)"
  echo "  console         Open Rails console"
  echo "  bash            Open bash shell in web container"
  echo "  psql            Open PostgreSQL console"
  echo "  redis-cli       Open Redis CLI"
  echo "  test [path]     Run RSpec tests"
  echo "  rubocop         Run RuboCop linter"
  echo "  migrate         Run pending migrations"
  echo "  rollback        Rollback last migration"
  echo "  db:reset        Reset database"
  echo "  db:seed         Seed database"
  echo "  clean           Clean up Docker resources"
  echo "  status          Show service status"
  echo ""
}

function info() {
  echo -e "${BLUE}==>${NC} $1"
}

function success() {
  echo -e "${GREEN}✓${NC} $1"
}

function warning() {
  echo -e "${YELLOW}⚠${NC} $1"
}

function error() {
  echo -e "${RED}✗${NC} $1"
}

case "$1" in
  up)
    info "Starting services..."
    $COMPOSE_CMD up -d
    success "Services started! Application available at http://localhost:3000"
    info "View logs with: bin/dev-docker logs -f"
    ;;
  
  down)
    info "Stopping services..."
    $COMPOSE_CMD down
    success "Services stopped"
    ;;
  
  restart)
    info "Restarting services..."
    $COMPOSE_CMD restart
    success "Services restarted"
    ;;
  
  build)
    info "Building containers..."
    $COMPOSE_CMD build
    success "Build complete"
    ;;
  
  logs)
    shift
    $COMPOSE_CMD logs "$@"
    ;;
  
  console)
    info "Opening Rails console..."
    $COMPOSE_CMD exec web bin/rails console
    ;;
  
  bash)
    info "Opening bash shell..."
    $COMPOSE_CMD exec web bash
    ;;
  
  psql)
    info "Opening PostgreSQL console..."
    $COMPOSE_CMD exec db psql -U postgres -d baas_development
    ;;
  
  redis-cli)
    info "Opening Redis CLI..."
    $COMPOSE_CMD exec redis redis-cli
    ;;
  
  test)
    shift
    if [ -z "$1" ]; then
      info "Running all tests..."
      $COMPOSE_CMD exec web bin/rspec
    else
      info "Running tests: $1"
      $COMPOSE_CMD exec web bin/rspec "$1"
    fi
    ;;
  
  rubocop)
    info "Running RuboCop..."
    $COMPOSE_CMD exec web bundle exec rubocop
    ;;
  
  migrate)
    info "Running migrations..."
    $COMPOSE_CMD exec web bin/rails db:migrate
    success "Migrations complete"
    ;;
  
  rollback)
    warning "Rolling back last migration..."
    $COMPOSE_CMD exec web bin/rails db:rollback
    success "Rollback complete"
    ;;
  
  db:reset)
    warning "Resetting database..."
    $COMPOSE_CMD exec web bin/rails db:reset
    success "Database reset complete"
    ;;
  
  db:seed)
    info "Seeding database..."
    $COMPOSE_CMD exec web bin/rails db:seed
    success "Database seeded"
    ;;
  
  clean)
    warning "Cleaning up Docker resources..."
    $COMPOSE_CMD down -v
    docker system prune -f
    success "Cleanup complete"
    ;;
  
  status)
    info "Service status:"
    $COMPOSE_CMD ps
    ;;
  
  *)
    print_usage
    exit 1
    ;;
esac
